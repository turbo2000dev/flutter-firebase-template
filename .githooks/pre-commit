#!/bin/bash
# Pre-commit hook for Flutter projects
# Ensures code quality before commits

set -e

echo "ğŸ” Running pre-commit checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_info() {
    echo "â„¹ï¸  $1"
}

# Check if Flutter is installed
if ! command -v flutter &> /dev/null; then
    print_error "Flutter is not installed or not in PATH"
    exit 1
fi

# Get list of staged Dart files
DART_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.dart$' || true)

if [ -z "$DART_FILES" ]; then
    print_info "No Dart files to check"
    exit 0
fi

echo "ğŸ“ Checking ${#DART_FILES[@]} Dart files..."
echo ""

# Step 1: Format code automatically
print_info "Step 1/3: Auto-formatting code..."

# Check if files need formatting
if dart format --set-exit-if-changed $DART_FILES > /dev/null 2>&1; then
    print_success "Code already formatted"
else
    # Format files automatically
    print_info "Formatting files..."
    dart format $DART_FILES > /dev/null 2>&1

    # Re-stage formatted files
    git add $DART_FILES
    print_success "Code auto-formatted and re-staged"
fi
echo ""

# Step 2: Analyze code
print_info "Step 2/3: Analyzing code..."
if flutter analyze --no-pub; then
    print_success "Static analysis: OK"
else
    print_error "Static analysis: FAILED"
    echo ""
    echo "Please fix the analysis issues before committing."
    echo "Run: flutter analyze"
    exit 1
fi
echo ""

# Step 3: Run tests (only if test files changed or if flag is set)
TEST_FILES=$(echo "$DART_FILES" | grep '_test\.dart$' || true)
if [ ! -z "$TEST_FILES" ] || [ "$RUN_TESTS" = "1" ]; then
    print_info "Step 3/3: Running tests..."
    if flutter test; then
        print_success "Tests: PASSED"
    else
        print_error "Tests: FAILED"
        echo ""
        echo "Please fix failing tests before committing."
        echo "Run: flutter test"
        exit 1
    fi
else
    print_warning "Step 3/3: Tests skipped (no test files changed)"
    print_info "To run tests, set RUN_TESTS=1 environment variable"
fi
echo ""

# All checks passed
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
print_success "All pre-commit checks passed!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

exit 0
