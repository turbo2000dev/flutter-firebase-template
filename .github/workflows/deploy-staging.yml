name: Deploy to Staging

on:
  push:
    branches:
      - staging
  workflow_dispatch:  # Allow manual trigger

env:
  FLUTTER_VERSION: '3.38.0'
  NODE_VERSION: '20'

jobs:
  check-urgent:
    name: Check for Urgent Deploy
    runs-on: ubuntu-latest
    outputs:
      is_urgent: ${{ steps.check.outputs.urgent }}
    steps:
      - name: Check commit message for URGENT prefix
        id: check
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [[ "$COMMIT_MSG" == URGENT* ]]; then
            echo "urgent=true" >> $GITHUB_OUTPUT
            echo "::warning::‚ö†Ô∏è URGENT deployment detected - skipping tests!"
          else
            echo "urgent=false" >> $GITHUB_OUTPUT
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: check-urgent
    if: needs.check-urgent.outputs.is_urgent != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage

      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Check coverage
        run: |
          # Remove generated files from coverage
          lcov --ignore-errors unused --remove coverage/lcov.info \
            '*.g.dart' \
            '*.freezed.dart' \
            '*.gr.dart' \
            '*.mocks.dart' \
            '**/generated/**' \
            '**/l10n/**' \
            -o coverage/lcov_filtered.info

          echo "=== Coverage (excluding generated code) ==="
          lcov --summary coverage/lcov_filtered.info 2>&1

          # Extract coverage percentage
          COVERAGE=$(lcov --summary coverage/lcov_filtered.info 2>&1 | grep "lines" | sed 's/.*lines[^0-9]*\([0-9][0-9]*\.[0-9]*\).*/\1/')
          echo "Parsed Coverage: $COVERAGE%"

          if [ -z "$COVERAGE" ]; then
            echo "‚ö†Ô∏è Could not parse coverage percentage"
          elif (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "‚ö†Ô∏è Coverage is below 80% ($COVERAGE%)"
          else
            echo "‚úÖ Coverage is $COVERAGE% (meets 80% threshold)"
          fi

  deploy-staging:
    name: Build and Deploy to Staging
    runs-on: ubuntu-latest
    needs: [check-urgent, test]
    if: always() && (needs.check-urgent.outputs.is_urgent == 'true' || needs.test.result == 'success')
    environment:
      name: staging
      url: https://staging.{{PROD_DOMAIN}}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: landing-page/package-lock.json

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build Astro landing page
        if: hashFiles('landing-page/package.json') != ''
        run: |
          cd landing-page
          npm ci
          npm run build
          mkdir -p ../public
          cp -r dist/* ../public/

      - name: Create placeholder landing page
        if: hashFiles('landing-page/package.json') == ''
        run: |
          mkdir -p public
          echo '<!DOCTYPE html><html><head><title>Retirement App - Staging</title></head><body><h1>Staging Environment</h1><a href="/app">Open App</a></body></html>' > public/index.html

      - name: Build Flutter web
        run: |
          flutter build web --dart-define=ENVIRONMENT=staging --base-href /app/
          mkdir -p public/app
          cp -r build/web/* public/app/

      - name: Deploy to Firebase Hosting (Staging)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_{{PROJECT_NAME_UPPER}} }}
          projectId: {{FIREBASE_PROJECT_ID}}
          target: staging
          channelId: live

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.check-urgent.outputs.is_urgent }}" == "true" ]; then
            echo "> [!CAUTION]" >> $GITHUB_STEP_SUMMARY
            echo "> **URGENT DEPLOYMENT** - Tests were skipped! Follow up with a proper tested deployment." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Landing Page: https://staging.{{PROD_DOMAIN}}" >> $GITHUB_STEP_SUMMARY
          echo "- Flutter App: https://staging.{{PROD_DOMAIN}}/app" >> $GITHUB_STEP_SUMMARY
