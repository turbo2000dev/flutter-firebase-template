name: Deploy Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main ]

jobs:
  deploy-preview:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.0'
          channel: 'stable'
          cache: true

      - name: Enable web support
        run: flutter config --enable-web

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build Web
        run: flutter build web --release

      - name: Deploy Preview to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_{{PROJECT_NAME_UPPER}} }}
          projectId: {{FIREBASE_PROJECT_ID}}
          expires: 7d
        id: firebase_hosting_preview

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        if: steps.firebase_hosting_preview.outputs.details_url
        with:
          script: |
            const previewUrl = '${{ steps.firebase_hosting_preview.outputs.details_url }}';
            const message = `## üöÄ Preview Deployment

            Your PR has been deployed to a preview environment!

            **Preview URL:** ${previewUrl}

            This preview will be available for 7 days.

            ‚ö†Ô∏è **Note:** This preview uses the production Firebase project. Use test data only.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
