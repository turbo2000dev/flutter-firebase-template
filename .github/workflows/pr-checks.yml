name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Quick checks for PRs
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Check formatting
        run: dart format --set-exit-if-changed .

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage

      - name: Generate coverage report
        run: |
          if [ -f coverage/lcov.info ]; then
            echo "‚úÖ Coverage report generated"
            # Simple coverage percentage calculation
            LINES=$(grep -c "^DA:" coverage/lcov.info || echo 0)
            HIT=$(grep "^DA:" coverage/lcov.info | grep -v ",0" | wc -l || echo 0)
            if [ "$LINES" -gt 0 ]; then
              COVERAGE=$(awk "BEGIN {printf \"%.1f\", ($HIT / $LINES) * 100}")
              echo "üìä Coverage: $COVERAGE%"
              echo "coverage=$COVERAGE" >> $GITHUB_ENV
            fi
          fi

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = process.env.coverage || 'N/A';
            const message = `## üîç PR Checks Results

            ‚úÖ Code formatting: Passed
            ‚úÖ Static analysis: Passed
            ‚úÖ Tests: Passed
            üìä Coverage: ${coverage}%

            All checks passed! Ready for review.`;

            const prNumber = context.payload.pull_request?.number;
            if (prNumber) {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            } else {
              console.log('No PR number found, skipping comment');
            }

  # Check for breaking changes
  breaking-changes:
    name: Check Breaking Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for breaking changes
        run: |
          # Check if any breaking change patterns exist in commit messages
          if git log origin/main..HEAD --oneline | grep -iE "breaking|major|!:"; then
            echo "‚ö†Ô∏è Potential breaking changes detected"
            echo "Please ensure CHANGELOG.md is updated"
          else
            echo "‚úÖ No breaking changes detected"
          fi

      - name: Check for migration files
        run: |
          if git diff --name-only origin/main...HEAD | grep -E "migration|schema"; then
            echo "‚ö†Ô∏è Database schema changes detected"
            echo "Ensure migration documentation is complete"
          else
            echo "‚úÖ No schema changes detected"
          fi
