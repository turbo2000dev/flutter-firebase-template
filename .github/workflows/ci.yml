# =============================================================================
# CI/CD Pipeline - Unified Workflow
# =============================================================================
#
# This single workflow handles all CI/CD tasks:
# - Code quality and testing (PRs and pushes)
# - Firebase deployments (Functions, Firestore, Images)
# - Web deployment to Firebase Hosting
# - iOS deployment to TestFlight
# - Android deployment to Play Store
#
# Job Groups (after tests pass):
#   Group 1: Firebase Infrastructure (parallel)
#     - Deploy Wizard Images
#     - Deploy Firestore Rules & Indexes
#     - Deploy Firebase Functions
#
#   Group 2: App Deployments (parallel)
#     - Build & Deploy Web to Production
#     - Build & Deploy iOS to TestFlight
#     - Build & Deploy Android to Play Store
#
# =============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [dev]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to deploy (for manual trigger)'
        required: false
        default: 'all'
        type: choice
        options:
          - web
          - ios
          - android
          - all

env:
  FLUTTER_VERSION: '3.38.0'
  RUBY_VERSION: '3.2'
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # ===========================================================================
  # Code Quality & Testing
  # ===========================================================================
  test:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Verify formatting
        run: dart format --set-exit-if-changed .

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test --coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Calculate coverage percentage
        id: coverage
        run: |
          if [ -f coverage/lcov.info ]; then
            LINES=$(grep -c "^DA:" coverage/lcov.info || echo 0)
            HIT=$(grep "^DA:" coverage/lcov.info | grep -v ",0" | wc -l || echo 0)
            if [ "$LINES" -gt 0 ]; then
              COVERAGE=$(awk "BEGIN {printf \"%.1f\", ($HIT / $LINES) * 100}")
              echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
              echo "ðŸ“Š Coverage: $COVERAGE%"
            fi
          fi

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}' || 'N/A';
            const message = `## ðŸ” CI Results

            âœ… Code formatting: Passed
            âœ… Static analysis: Passed
            âœ… Tests: Passed
            ðŸ“Š Coverage: ${coverage}%

            All checks passed! Ready for review.`;

            const prNumber = context.payload.pull_request?.number;
            if (prNumber) {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });
              const botComment = comments.find(c => c.body.includes('## ðŸ” CI Results'));
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: message
                });
              } else {
                await github.rest.issues.createComment({
                  issue_number: prNumber,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: message
                });
              }
            }

  # ===========================================================================
  # Security Audit (runs in parallel with tests)
  # ===========================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run dependency audit
        run: flutter pub outdated --show-all || true

      - name: Check for vulnerabilities
        run: |
          echo "Checking for known vulnerabilities..."
          echo "Security audit completed"

  # ===========================================================================
  # Check Breaking Changes (PR only)
  # ===========================================================================
  breaking-changes:
    name: Check Breaking Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for breaking changes
        run: |
          if git log origin/dev..HEAD --oneline | grep -iE "breaking|major|!:"; then
            echo "âš ï¸ Potential breaking changes detected"
            echo "Please ensure CHANGELOG.md is updated"
          else
            echo "âœ… No breaking changes detected"
          fi

      - name: Check for migration files
        run: |
          if git diff --name-only origin/dev...HEAD | grep -E "migration|schema"; then
            echo "âš ï¸ Database schema changes detected"
            echo "Ensure migration documentation is complete"
          else
            echo "âœ… No schema changes detected"
          fi

  # ===========================================================================
  # Prepare Build Numbers (for app deployments)
  # ===========================================================================
  prepare:
    name: Prepare Build
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      build_number: ${{ steps.build_number.outputs.value }}
      version: ${{ steps.version.outputs.value }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate build number
        id: build_number
        run: |
          echo "value=$(git rev-list --count HEAD)" >> $GITHUB_OUTPUT

      - name: Get version from pubspec
        id: version
        run: |
          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: *\([0-9.]*\).*/\1/')
          echo "value=$VERSION" >> $GITHUB_OUTPUT

      - name: Print build info
        run: |
          echo "Version: ${{ steps.version.outputs.value }}"
          echo "Build Number: ${{ steps.build_number.outputs.value }}"

  # ===========================================================================
  # GROUP 1: Firebase Infrastructure (parallel)
  # ===========================================================================

  # Deploy Wizard Images to Firebase Storage
  deploy-images:
    name: Deploy Wizard Images
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for image changes
        id: check-images
        run: |
          if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "^images/"; then
            echo "images_changed=true" >> $GITHUB_OUTPUT
            echo "Images directory has changes"
          else
            echo "images_changed=false" >> $GITHUB_OUTPUT
            echo "No changes in images directory"
          fi

      - name: Setup Google Cloud SDK
        if: steps.check-images.outputs.images_changed == 'true'
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      - name: Authenticate to Google Cloud
        if: steps.check-images.outputs.images_changed == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_{{PROJECT_NAME_UPPER}} }}

      - name: Upload images to Firebase Storage
        if: steps.check-images.outputs.images_changed == 'true'
        run: |
          STORAGE_BUCKET="{{FIREBASE_PROJECT_ID}}.firebasestorage.app"
          REMOTE_PATH="wizard_images"

          echo "Uploading wizard images to Firebase Storage..."

          if [ -d "images/en" ]; then
            echo "Uploading English images..."
            for file in images/en/*.png; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "  Uploading: $filename"
                gsutil -h "Cache-Control:public, max-age=604800" \
                       -h "Content-Type:image/png" \
                       cp "$file" "gs://$STORAGE_BUCKET/$REMOTE_PATH/en/$filename"
              fi
            done
          fi

          if [ -d "images/fr" ]; then
            echo "Uploading French images..."
            for file in images/fr/*.png; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                echo "  Uploading: $filename"
                gsutil -h "Cache-Control:public, max-age=604800" \
                       -h "Content-Type:image/png" \
                       cp "$file" "gs://$STORAGE_BUCKET/$REMOTE_PATH/fr/$filename"
              fi
            done
          fi

          echo "âœ“ Image upload complete"

      - name: Skip upload (no changes)
        if: steps.check-images.outputs.images_changed != 'true'
        run: echo "No image changes detected, skipping upload"

  # Deploy Firestore Rules & Indexes
  deploy-firestore:
    name: Deploy Firestore Rules & Indexes
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Firebase Service Account
        run: |
          echo "$FIREBASE_SERVICE_ACCOUNT" > $HOME/firebase-service-account.json
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_{{PROJECT_NAME_UPPER}} }}

      - name: Deploy Firestore Rules & Indexes
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/../firebase-service-account.json
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="$HOME/firebase-service-account.json"
          firebase deploy --only firestore:rules,firestore:indexes --project {{FIREBASE_PROJECT_ID}} --non-interactive

  # Deploy Firebase Functions
  deploy-functions:
    name: Deploy Firebase Functions
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'functions/requirements.txt'

      - name: Create virtual environment and install dependencies
        working-directory: functions
        run: |
          python3.12 -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ“ Virtual environment created and dependencies installed"

      - name: Validate Python code
        working-directory: functions
        run: |
          source venv/bin/activate
          python -m py_compile main.py
          python -m py_compile excel_generator.py
          python -m py_compile models.py
          echo "âœ“ Python validation successful"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Setup Firebase Service Account
        run: |
          echo "$FIREBASE_SERVICE_ACCOUNT" > $HOME/firebase-service-account.json
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_{{PROJECT_NAME_UPPER}} }}

      - name: Deploy Firebase Functions
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/../firebase-service-account.json
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="$HOME/firebase-service-account.json"
          firebase deploy --only functions --project {{FIREBASE_PROJECT_ID}} --non-interactive --force

      - name: Verify deployment
        run: |
          echo "âœ“ Firebase Functions deployed successfully"
          echo "Function URL: https://us-central1-{{FIREBASE_PROJECT_ID}}.cloudfunctions.net/generate_projection_excel"

  # ===========================================================================
  # GROUP 2: App Deployments (parallel)
  # ===========================================================================

  # Build & Deploy Web to Firebase Hosting (Production)
  deploy-web:
    name: Build & Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 20
    environment:
      name: production
      url: https://{{PROD_DOMAIN}}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: landing-page/package-lock.json

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run code generation
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build Astro landing page
        if: hashFiles('landing-page/package.json') != ''
        run: |
          cd landing-page
          npm ci
          npm run build
          mkdir -p ../public
          cp -r dist/* ../public/

      - name: Create placeholder landing page
        if: hashFiles('landing-page/package.json') == ''
        run: |
          mkdir -p public
          echo '<!DOCTYPE html><html><head><title>{{PROJECT_DISPLAY_NAME}}</title></head><body><h1>{{PROJECT_DISPLAY_NAME}}</h1><a href="/app">Open App</a></body></html>' > public/index.html

      - name: Build Flutter web (Production)
        run: |
          flutter build web --release --dart-define=ENVIRONMENT=prod --base-href /app/
          mkdir -p public/app
          cp -r build/web/* public/app/

      - name: Deploy to Firebase Hosting (Production)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_{{PROJECT_NAME_UPPER}} }}
          projectId: {{FIREBASE_PROJECT_ID}}
          target: prod
          channelId: live

      - name: Create Git Tag
        continue-on-error: true
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          TAG="deploy-$(date +'%Y%m%d-%H%M%S')"
          git tag -a "$TAG" -m "Production deployment"
          git push origin "$TAG"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Production Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- Landing Page: https://{{PROD_DOMAIN}}" >> $GITHUB_STEP_SUMMARY
          echo "- Flutter App: https://{{PROD_DOMAIN}}/app" >> $GITHUB_STEP_SUMMARY

  # Build & Deploy iOS to TestFlight
  deploy-ios:
    name: Build & Deploy iOS to TestFlight
    needs: prepare
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          bundle install

      - name: Setup Firebase config
        env:
          IOS_GOOGLE_SERVICE_INFO: ${{ secrets.IOS_GOOGLE_SERVICE_INFO }}
        run: |
          echo "$IOS_GOOGLE_SERVICE_INFO" | base64 --decode > ios/Runner/GoogleService-Info.plist

      - name: Setup iOS signing
        env:
          IOS_CERTIFICATE_P12: ${{ secrets.IOS_CERTIFICATE_P12 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD || 'temporary_password' }}
        run: |
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Add to search list so Xcode can find it
          security list-keychains -d user -s build.keychain $(security list-keychains -d user | tr -d '"')

          # Import certificate
          echo "$IOS_CERTIFICATE_P12" | base64 --decode > distribution.p12
          security import distribution.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -A

          # Allow codesign to access the keychain without prompting
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain

          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

          # Verify certificate was imported
          echo "Certificates in keychain:"
          security find-identity -v -p codesigning build.keychain

      - name: Build and upload to TestFlight
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          bundle exec fastlane ios beta build_number:${{ needs.prepare.outputs.build_number }}

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true

  # Build & Deploy Android to Play Store
  deploy-android:
    name: Build & Deploy Android to Play Store
    needs: prepare
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: |
          flutter pub get
          flutter pub run build_runner build --delete-conflicting-outputs
          bundle install

      - name: Setup Google Services config
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > android/app/google-services.json
            echo "âœ“ google-services.json created"
          else
            echo "âš ï¸ GOOGLE_SERVICES_JSON_BASE64 not set"
          fi

      - name: Setup Android signing
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          # Decode keystore
          echo "$ANDROID_KEYSTORE" | base64 --decode > android/upload-keystore.jks

          # Create key.properties
          cat > android/key.properties << EOF
          storePassword=$ANDROID_STORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=../upload-keystore.jks
          EOF

      - name: Setup Play Store credentials
        env:
          PLAY_STORE_SERVICE_ACCOUNT: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT }}
        run: |
          echo "$PLAY_STORE_SERVICE_ACCOUNT" | base64 --decode > fastlane/play-store-key.json

      - name: Build and upload to Play Store
        env:
          GOOGLE_PLAY_JSON_KEY_PATH: fastlane/play-store-key.json
        run: |
          bundle exec fastlane android beta build_number:${{ needs.prepare.outputs.build_number }}

      - name: Cleanup credentials
        if: always()
        run: |
          rm -f android/upload-keystore.jks
          rm -f android/key.properties
          rm -f fastlane/play-store-key.json

  # ===========================================================================
  # Deployment Summary
  # ===========================================================================
  summary:
    name: Deployment Summary
    needs: [prepare, deploy-images, deploy-firestore, deploy-functions, deploy-web, deploy-ios, deploy-android]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number:** ${{ needs.prepare.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Firebase Infrastructure" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.deploy-images.result }}" == "success" ]]; then
            echo "- âœ… **Wizard Images:** Deployed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-images.result }}" == "skipped" ]]; then
            echo "- â­ï¸ **Wizard Images:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Wizard Images:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.deploy-firestore.result }}" == "success" ]]; then
            echo "- âœ… **Firestore Rules:** Deployed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-firestore.result }}" == "skipped" ]]; then
            echo "- â­ï¸ **Firestore Rules:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Firestore Rules:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.deploy-functions.result }}" == "success" ]]; then
            echo "- âœ… **Functions:** Deployed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-functions.result }}" == "skipped" ]]; then
            echo "- â­ï¸ **Functions:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Functions:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### App Deployments" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.deploy-web.result }}" == "success" ]]; then
            echo "- âœ… **Web:** Deployed to Production" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-web.result }}" == "skipped" ]]; then
            echo "- â­ï¸ **Web:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Web:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.deploy-ios.result }}" == "success" ]]; then
            echo "- âœ… **iOS:** Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-ios.result }}" == "skipped" ]]; then
            echo "- â­ï¸ **iOS:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **iOS:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.deploy-android.result }}" == "success" ]]; then
            echo "- âœ… **Android:** Deployed to Play Store" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-android.result }}" == "skipped" ]]; then
            echo "- â­ï¸ **Android:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Android:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
